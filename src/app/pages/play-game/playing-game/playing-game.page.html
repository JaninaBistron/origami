<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="navigateHome()">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title *ngIf="game">{{ game.name }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="nextTask()">
        <ion-icon name="arrow-forward"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content forceOverscroll="false">
  <div class="wrapper" [class.blur]="showSuccess">
    <div #map class="map" [class.blur]="task != null && task.type == 'nav-arrow'"></div>
    <div *ngIf="swipe" #swipeMap class="map"></div>

    <ion-card class="overlay task-control ion-padding" [class.minimized]="panelMinimized" [class.full]="task.type == 'nav-arrow'" *ngIf="task">
      <div class="top-info">
        <div *ngIf="!panelMinimized">
          <ion-chip color="primary" *ngIf="task.type.includes('nav')">
            <ion-icon name="navigate"></ion-icon>
          </ion-chip>
          <ion-chip color="secondary" *ngIf="task.type.includes('theme')">
            <ion-icon name="clipboard"></ion-icon>
          </ion-chip>
          <ion-chip color="medium" *ngIf="task.type.includes('module')">
            <ion-icon name="list"></ion-icon>
          </ion-chip>
          <ion-chip color="warning" *ngIf="task.type.includes('info')">
            <ion-icon name="information-circle-outline"></ion-icon>
          </ion-chip>
        </div>
        <p *ngIf="!panelMinimized">Aufgabe {{ taskIndex + 1 }} von {{ game.tasks.length }}</p>
        <ion-button fill="clear" (click)="togglePanel()">
          <ion-icon slot="end" name="close" size="large" *ngIf="!panelMinimized"></ion-icon>
          <ion-icon slot="end" name="expand" size="large" *ngIf="panelMinimized"></ion-icon>
        </ion-button>
      </div>
      <div class="task-wrapper" *ngIf="!panelMinimized">
        <!-- <div
        class="task-wrapper"
        [ngStyle]="{
          'flex-wrap': [
            'nav-arrow',
            'theme-object',
            'theme-direction'
          ].includes(task.type)
            ? 'wrap'
            : 'nowrap'
        }"
      > -->
        <div class="compass large" *ngIf="task.type == 'nav-arrow'">
          <img src="/assets/icons/compass.svg" [ngStyle]="{
              transform: 'rotate(' + targetHeading + 'deg)'
            }" />
          <p>Distanz: {{ Math.round(targetDistance) }} m</p>
        </div>

        <div class="task-wrapper" [ngStyle]="{
            'flex-wrap': [
              'nav-arrow',
              'theme-object',
              'theme-direction'
            ].includes(task.type)
              ? 'wrap'
              : 'nowrap'
          }">
          <div class="compass bearing" *ngIf="task.type == 'theme-direction' && 
            task.settings['question-type'].name && 
            task.settings['question-type'].name != 'question-type-current-direction' && 
            task.settings['question-type'].name != 'photo' && 
            task.settings['question-type'].name != 'question-type-map'">
            <img src="/assets/icons/direction-bearing.svg" [ngStyle]="{
                transform:
                  'translateX(-50%) rotate(0deg)'
              }" />
            <img src="/assets/icons/compass.svg" [ngStyle]="{
                transform: 'translateX(-50%) rotate(' + indicatedDirection + 'deg)'
              }" />
          </div>
        </div>
        <div class="photo-container" *ngIf="
            (task.type == 'theme-object' &&
            task.settings['question-type'].name == 'photo') ||
            (task.type == 'theme-direction' &&
            task.settings['question-type'].name == 'photo')
          ">
          <img [src]="task.settings['question-type'].settings.photo" />
        </div>
        <div class="photo-container" *ngIf="task.type == 'info' && task.settings.photo">
          <img [src]="task.settings.photo" />
        </div>
        <div *ngIf="task.settings['answer-type'] &&
            task.settings['answer-type'].name == 'multiple-choice'" class="multiple-choice">
          <div *ngFor="let item of task.settings['answer-type'].settings['multiple-choice'] | keyvalue | shuffle">
            <ion-thumbnail slot="start">
              <img [src]=item.value class="multiple-choize-img" (click)='onMultipleChoiceSelected(item, $event)' />
            </ion-thumbnail>
          </div>
        </div>

        <div class="task-text">
          <p>
            {{ task.settings.text }}
          </p>
          <p *ngIf='task.settings["question-type"]?.settings["object-description"]'>
            {{ task.settings["question-type"].settings["object-description"] }}
          </p>
          <p *ngIf="task.settings.confirmation">
            Bestätige mit OK
          </p>
        </div>

        <div *ngIf="
            task.settings['answer-type'] &&
            task.settings['answer-type'].name == 'take-photo'
          ">
          <ion-thumbnail slot="start" *ngIf="photo">
            <img [src]="photo" />
          </ion-thumbnail>
          <ion-button color=secondary (click)="capturePhoto()">
            <ion-icon name="camera"></ion-icon>
          </ion-button>
        </div>

        <ion-button class="confirm" color=secondary (click)="onOkClicked()" *ngIf="task.settings.confirmation && task.type.includes('theme')">OK
        </ion-button>

        <ion-button class="confirm" color=primary (click)="onOkClicked()" *ngIf="task.settings.confirmation && task.type.includes('nav')">OK
        </ion-button>

      </div>
    </ion-card>
  </div>

  <ion-card class="overlay success" *ngIf="showSuccess">
    <h3>Herzlichen Glückwunsch!</h3>
    <p>Du hast das Spiel beendet</p>
    <lottie-animation-view [options]="lottieConfig" [width]="300" [height]="300">
    </lottie-animation-view>
    <ion-button (click)="navigateHome()" [disabled]="!uploadDone">Fertig</ion-button>
  </ion-card>

  <!-- <div class="overlay ion-padding" *ngIf="currentTask">
    <ion-img [src]="currentTask.question.img" *ngIf="currentTask.question.img"></ion-img>
    <h2>{{ currentTask.question.txt }}</h2>
    <ion-grid>
      <ion-row>
        <ion-col *ngFor="let answer of currentTask.answers">
          <ion-button (click)=nextTask()>
            {{ answer.txt }}
          </ion-button>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div> -->
</ion-content>